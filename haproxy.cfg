global
    daemon
    maxconn 512
    log stdout format raw local0
    
    # COMMAND CENTER
    stats socket /var/run/haproxy/haproxy.sock mode 666 level admin
    stats timeout 30s

    # MODERN SECURITY DEFAULTS
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11 no-tlsv12
    ssl-default-server-options ssl-min-ver TLSv1.3

defaults
    mode http
    log global
    option httplog
    option dontlognull
    timeout connect 5s
    timeout client 60s
    timeout server 300s   
    timeout http-request 10s

frontend ai_egress_gateway
    bind *:8080
    description "Secure Egress for AI Agents"

    # 1. INTERNAL COMMUNICATION (Always allow first)
    acl is_local_traffic hdr(host) -i security-brain:11434 inspector-api:5000
    http-request allow if is_local_traffic

    # 2. DEFINE ACCESS LISTS
    acl is_ai_provider hdr(host) -i api.anthropic.com api.openai.com api.deepseek.com
    acl is_ai_provider hdr(host) -i api.groq.com openrouter.ai generativelanguage.googleapis.com
    acl is_telegram hdr(host) -i api.telegram.org api.telegram.com

    acl is_dev_tool hdr(host) -m reg ^(api\.)?github\.com$
    acl is_dev_tool hdr(host) -i registry.npmjs.org pypi.org
    
    acl is_common_skill hdr(host) -i api.tavily.com api.search.brave.com serpapi.com
    acl is_runtime_approved hdr(host) -f /etc/haproxy/runtime_whitelist.lst

    # 3. PRIVACY PROTECTION (Must happen before the final allow/deny)
    http-request del-header User-Agent
    http-request del-header Referer
    http-request del-header X-Forwarded-For
    http-request set-header User-Agent "Mozilla/5.0 (Secure-AI-Sandbox/1.0)"

    # 4. THE DECISION (Logic fix to avoid NOOP)
    # We check all allowed conditions first.
    http-request allow if is_ai_provider || is_dev_tool || is_common_skill || is_runtime_approved || is_telegram
    
    # 5. CATCH-ALL DENY (This is the only one that doesn't need an 'if')
    http-request deny deny_status 403

    default_backend ai_provider_backend

backend ai_provider_backend
    server secure_egress :443 ssl verify none sni req.hdr(host)
